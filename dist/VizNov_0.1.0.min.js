/*! VizNov 2014-01-26 */
var VizNovHelper={drawBox:function(a,b,c,d,e,f,g,h,i){var j=$("#"+f),k=h;if(g&&$.each(g,function(){k+=" "+this}),0===j.length){var l=document.createElementNS("http://www.w3.org/2000/svg","rect");e>0&&(l.setAttribute("rx",e),l.setAttribute("ry",e)),l.setAttribute("x",a),l.setAttribute("y",b),l.setAttribute("width",c),l.setAttribute("height",d),l.setAttribute("id",f),l.setAttribute("class",k),document.getElementById("stuff").appendChild(l),j=$("#"+f),j.click(i)}return j},stepText:function(a,b,c){var d=b.split(""),e=0,f=$("#"+a),g=setInterval(function(){if(e<d.length&&f.text(f.text()+d[e++]),e>=d.length){var a=document.createElementNS("http://www.w3.org/2000/svg","image");a.setAttributeNS(null,"height","20"),a.setAttributeNS(null,"width","20"),a.setAttributeNS(null,"id","cursor"),a.setAttributeNS("http://www.w3.org/1999/xlink","href","assets/img/cursor.png"),a.setAttributeNS(null,"x",f.position().left+f.width()+15),a.setAttributeNS(null,"y",f.position().top+5),$(a).insertAfter(f),clearInterval(g),game&&clearInterval(game.cursorBlink),game.cursorBlink=setInterval(function(){var a=$("#cursor");a.css("opacity")>.5?a.fadeTo(50,0):a.fadeTo(50,1)},400)}},c)},textBox:function(a,b,c,d,e,f,g,h,i,j){$("#cursor").remove();var k=$("#"+g),l="";if(h&&$.each(h,function(){l+=this+" "}),0===k.length){var m=document.createElementNS("http://www.w3.org/2000/svg","text");m.setAttribute("width",c),m.setAttribute("height",d),m.setAttribute("x",a),m.setAttribute("y",b),m.setAttribute("id",g),m.setAttribute("font-style",f),m.setAttribute("class",l),document.getElementById("stuff").appendChild(m),k=$("#"+g)}else k.empty();return i?VizNovHelper.stepText(g,e,25):k.text(e),k.click(j),k},showChoices:function(a,b){var c=$("#speechBox");0!==$("#character").length&&$("#character").remove(),0!==c.length&&c.remove();var d,e;switch(b){case"bottom":d=.75*window.innerHeight;break;case"top":d=75;break;case"left":e=75;break;case"right":e=window.innerWidth-150}var f=a.length,g=50,h=250,i=50,j=f*h+(f-1)*g;$.each(a,function(b){var c="choice"+b;e=(window.innerWidth-j)/2+(h+g)*b,VizNovHelper.drawBox(e,d,h,i,5,c,["choice"],"charcoal",function(a){VizNovHelper.choiceClick($(a.target).next())});var f=VizNovHelper.getTextDim(a[b].text);VizNovHelper.textBox((h-f.width)/2+e,d+i/2+7,f.width,f.height,a[b].text,null,"choiceText"+b,["choice"],!1,function(a){VizNovHelper.choiceClick($(a.target))});var k=$("#"+c);k.on({mouseenter:function(){$(this).next().attr("fill","gray")},mouseleave:function(){$(this).next().attr("fill","black")}}),$("#choiceText"+b).on({mouseenter:function(){$(this).attr("fill","gray")},mouseleave:function(){$(this).attr("fill","black")}})})},getTextDim:function(a){var b='<div style="display:none;" id="hiddenText"></div>',c=$("body");c.append(b);var d=$("#hiddenText");d.text(a);var e=d.width(),f=d.height();return d.remove(),{width:e,height:f}},showBackground:function(a){var b=$("body"),c="url("+a+")";b.css("background-image",c)},showCharacter:function(a,b,c){var d=$("#character");if(0!==d.length&&d.remove(),"none"!==b){var e=document.createElementNS("http://www.w3.org/2000/svg","image");switch(e.setAttributeNS(null,"height","800"),e.setAttributeNS(null,"width","500"),e.setAttributeNS(null,"id","character"),e.setAttributeNS("http://www.w3.org/1999/xlink","href",a),e.setAttributeNS(null,"y","100"),b){case"right":e.setAttributeNS(null,"x",window.innerWidth-550);break;case"left":e.setAttributeNS(null,"x",50)}switch(c){case"dim":e.setAttributeNS(null,"opacity",.15)}$("#stuff").prepend(e)}},choiceClick:function(a){game.curPath.chosen(a.text())},playSong:function(a,b){game.track=new Audio(a),b&&game.track.addEventListener("ended",function(){this.currentTime=0,this.play()},!1),game.track.play()},transition:function(a,b){switch(game&&clearInterval(game.cursorBlink),$("svg").empty(),a){case void 0:$("#mask").css({display:"none"}),b();break;case"fadeInWhite":$("#mask").css({background:"white",display:"inline"}),$("#mask").fadeOut(2e3,b);break;case"fadeIn":$("#mask").css({background:"black",display:"inline"}),$("#mask").fadeOut(2e3,b);break;case"fadeOut":$("#mask").css({background:"black"}),$("#mask").fadeIn(2e3,b)}},fileName:function(a){if(!a)return"";var b=a.split("/");return b[b.length-1]}},VizNov=function(a){window.game=this,this.theme=a.theme,this.play=function(){this.start?this.start.play():console.log("No starting scene.")},this.stop=function(){$("body").empty(),game.track.pause(),game=null},this.changeMusic=function(a,b){b?game.track.pause():$(game.track).animate({volume:0},1e3),VizNovHelper.playSong(a,!0)},this.changeBackground=function(a){VizNovHelper.showBackground(a)},this.hideCharacter=function(){$("#character").remove()},this.Scene=function(a){var b;a&&(b=a.background,this.inTrans=a.inTrans,this.outTrans=a.outTrans,this.music=a.music),this.play=function(){game.track?VizNovHelper.fileName(game.track.src)!==VizNovHelper.fileName(this.music)&&($(game.track).animate({volume:0},1e3),this.music&&VizNovHelper.playSong(this.music,!0)):this.music&&VizNovHelper.playSong(this.music,!0),$("#stuff").empty(),game.curScene=this,VizNovHelper.showBackground(b);var a=this.mainPath;VizNovHelper.transition(this.inTrans,function(){a.play()})},this.setMain=function(a){return this.mainPath=a,this.mainPath},this.Path=function(a){this.text=a,this.lines=[],this.curLine=0,this.line=function(a){this.lines.push(a)},this.loadLines=function(a){var b=this;$.each(a,function(){b.line(this)})},this.exit=function(a){return this.nextScene=a,this},this.playLine=function(a){var b=this.lines[a],c=this.lines[a-1];if(b){if(b.before&&b.before(),b.choice)VizNovHelper.showChoices(b.choice.paths,"bottom");else if(b.say||b.think||b.sound){b.from&&(c&&b.from===c.from||VizNovHelper.showCharacter(b.from.image,b.placement?b.placement:b.from.placement,b.style));var d,e;b.say?d=b.from?"["+b.from.name+']: "'+b.say+'"':'"'+b.say+'"':b.think?d=b.think:b.sound&&(d=b.sound,e="italic"),VizNovHelper.drawBox(.025*window.innerWidth,.7*window.innerHeight,.95*window.innerWidth,.25*window.innerHeight,20,"speechBox",null,window.game.theme,function(){$("text").remove(),game.curPath.nextLine()}),VizNovHelper.textBox(.025*window.innerWidth+30,.7*window.innerHeight+40,.95*window.innerWidth-60,.25*window.innerHeight-60,d,e,"text"+this.curLine,null,!0,function(){$("text").remove(),game.curPath.nextLine()})}else game.curPath.nextLine();b.after&&b.after()}else{var f=this.nextScene;VizNovHelper.transition(game.curScene.outTrans,function(){f?f.play():game.stop()})}},this.nextLine=function(){this.curLine++,this.playLine(this.curLine)},this.chosen=function(a){$(".choice").remove();var b;$.each(this.lines[this.curLine].choice.paths,function(){this.text===a&&(b=this)}),b.play()},this.play=function(){game.curPath=this,this.playLine(this.curLine)}},this.Choice=function(a){this.paths=a.paths}},this.Character=function(a){this.name=a.name,this.image=a.image,this.placement=a.placement}};