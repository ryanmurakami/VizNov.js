/*! VizNov v.0.1.2 2014-03-29 */
var VizNov=function(a){window.game=this,this.theme=a.theme,this.fileName=function(a){if(!a)return"";var b=a.split("/");return b[b.length-1]}};VizNov.prototype.play=function(){this.start?this.start.play():console.log("No starting scene.")},VizNov.prototype.stop=function(){$("body").empty(),game.track.pause(),game=null},VizNov.prototype.changeMusic=function(a,b){b?game.track.pause():$(game.track).animate({volume:0},1e3),this.playSong(a,!0)},VizNov.prototype.changeBackground=function(a){this.showBackground(a)},VizNov.prototype.hideCharacter=function(){$("#character").remove()},VizNov.prototype.Scene=function(a){a&&(this.background=a.background,this.inTrans=a.inTrans,this.outTrans=a.outTrans,this.music=a.music)},VizNov.prototype.Scene.prototype.play=function(){game.track?game.fileName(game.track.src)!==game.fileName(this.music)&&($(game.track).animate({volume:0},1e3),this.music&&game.playSong(this.music,!0)):this.music&&game.playSong(this.music,!0),$("#stuff").empty(),game.curScene=this,game.showBackground(this.background);var a=this.mainPath;game.transition(this.inTrans,function(){a.play()})},VizNov.prototype.Scene.prototype.setMain=function(a){return this.mainPath=a,this.mainPath},VizNov.prototype.Scene.prototype.Path=function(a){this.text=a,this.lines=[],this.curLine=0,this.line=function(a){this.lines.push(a)}},VizNov.prototype.Scene.prototype.Path.prototype.loadLines=function(a){var b=this;$.each(a,function(){b.line(this)})},VizNov.prototype.Scene.prototype.Path.prototype.exit=function(a){return this.nextScene=a,this},VizNov.prototype.Scene.prototype.Path.prototype.playLine=function(a){var b=this.lines[a],c=this.lines[a-1];if(b){if(b.before&&b.before(),b.choice)game.showChoices(b.choice.paths,"bottom");else if(b.say||b.think||b.sound){b.from&&(c&&b.from===c.from||game.showCharacter(b.from.image,b.placement?b.placement:b.from.placement,b.style));var d,e;b.say?d=b.from?"["+b.from.name+']: "'+b.say+'"':'"'+b.say+'"':b.think?d=b.think:b.sound&&(d=b.sound,e="italic"),game.drawBox(.025*window.innerWidth,.7*window.innerHeight,.95*window.innerWidth,.25*window.innerHeight,20,"speechBox",null,window.game.theme,function(a){var b=$(a.target).closest("svg"),c=b.next("div");c.remove(),game.curPath.nextLine()}),game.textBox(.025*window.innerWidth+30,.7*window.innerHeight+30,null,.25*window.innerHeight-60,d,e,"text"+this.curLine,null,!0,function(a){$(a.target).remove(),game.curPath.nextLine()})}else game.curPath.nextLine();b.after&&b.after()}else{var f=this.nextScene;game.transition(game.curScene.outTrans,function(){f?f.play():game.stop()})}},VizNov.prototype.Scene.prototype.Path.prototype.nextLine=function(){this.curLine++,this.playLine(this.curLine)},VizNov.prototype.Scene.prototype.Path.prototype.chosen=function(a){$(".choice").remove();var b;$.each(this.lines[this.curLine].choice.paths,function(){return this.text===a?(b=this,!1):void 0}),b.play()},VizNov.prototype.Scene.prototype.Path.prototype.play=function(){game.curPath=this,this.playLine(this.curLine)},VizNov.prototype.Scene.prototype.Choice=function(a){this.paths=a.paths},VizNov.prototype.Character=function(a){this.name=a.name,this.image=a.image,this.placement=a.placement},VizNov.prototype.drawBox=function(a,b,c,d,e,f,g,h,i){var j=$("#"+f),k=h;if(g&&$.each(g,function(){k+=" "+this}),0===j.length){var l=document.createElementNS("http://www.w3.org/2000/svg","rect");e>0&&(l.setAttribute("rx",e),l.setAttribute("ry",e)),l.setAttribute("x",a),l.setAttribute("y",b),l.setAttribute("width",c),l.setAttribute("height",d),l.setAttribute("id",f),l.setAttribute("class",k),document.getElementById("stuff").appendChild(l),j=$("#"+f),j.click(i)}return j},VizNov.prototype.stepText=function(a,b,c){var d=b.split(""),e=0,f=$("#"+a),g=setInterval(function(){if(e<d.length&&f.text(f.text()+d[e++]),e>=d.length){var a='<img id="cursor"src ="assets/img/cursor.png" />';f.append(a),clearInterval(g),game&&clearInterval(game.cursorBlink),game.cursorBlink=setInterval(function(){var a=$("#cursor");a.css("opacity")>.5?a.fadeTo(50,0):a.fadeTo(50,1)},400)}},c)},VizNov.prototype.textBox=function(a,b,c,d,e,f,g,h,i,j){$("#cursor").remove();var k=$("#"+g),l="";return h&&$.each(h,function(){l+=this+" "}),0===k.length?($("#stuff").after('<div id="'+g+'"></div>'),k=$("#"+g),k.css("position","fixed"),k.css("top",b),k.css("left",a),k.css("height",d),k.css("width",c),k.css("font-style",f),k.addClass(l)):k.empty(),i?this.stepText(g,e,25):k.text(e),k.click(j),k},VizNov.prototype.showChoices=function(a,b){var c=$("#speechBox");0!==$("#character").length&&$("#character").remove(),0!==c.length&&c.remove();var d,e;switch(b){case"bottom":d=.75*window.innerHeight;break;case"top":d=75;break;case"left":e=75;break;case"right":e=window.innerWidth-150}var f=a.length,g=50,h=250,i=50,j=f*h+(f-1)*g;$.each(a,function(b){var c="choice"+b;e=(window.innerWidth-j)/2+(h+g)*b,game.drawBox(e,d,h,i,5,c,["choice"],"charcoal",function(a){game.choiceClick($(a.target).closest("svg").next("div"))});var f=game.getTextDim(a[b].text);game.textBox((h-f.width)/2+e,d+(i-f.height)/2,f.width,f.height,a[b].text,null,"choiceText"+b,["choice"],!1,function(a){game.choiceClick($(a.target))});var k=$("#"+c);k.on({mouseenter:function(){$(this).next().attr("fill","gray")},mouseleave:function(){$(this).next().attr("fill","black")}}),$("#choiceText"+b).on({mouseenter:function(){$(this).attr("fill","gray")},mouseleave:function(){$(this).attr("fill","black")}})})},VizNov.prototype.getTextDim=function(a){var b='<div style="display:none;" id="hiddenText"></div>',c=$("body");c.append(b);var d=$("#hiddenText");d.text(a);var e=d.width(),f=d.height();return d.remove(),{width:e,height:f}},VizNov.prototype.showBackground=function(a){var b=$("html"),c="url("+a+")";b.css("background-image",c)},VizNov.prototype.showCharacter=function(a,b,c){var d=$("#character");if(0!==d.length&&d.remove(),"none"!==b){var e=document.createElementNS("http://www.w3.org/2000/svg","image");switch(e.setAttributeNS(null,"height","800"),e.setAttributeNS(null,"width","500"),e.setAttributeNS(null,"id","character"),e.setAttributeNS("http://www.w3.org/1999/xlink","href",a),e.setAttributeNS(null,"y","100"),b){case"right":e.setAttributeNS(null,"x",window.innerWidth-550);break;case"left":e.setAttributeNS(null,"x",50)}switch(c){case"dim":e.setAttributeNS(null,"opacity",.15)}$("#stuff").prepend(e)}},VizNov.prototype.choiceClick=function(a){game.curPath.chosen(a.text())},VizNov.prototype.playSong=function(a,b){game.track=new Audio(a),b&&game.track.addEventListener("ended",function(){this.currentTime=0,this.play()},!1),game.track.play()},VizNov.prototype.transition=function(a,b){switch(game&&clearInterval(game.cursorBlink),$("svg").empty(),a){case void 0:$("#mask").css({display:"none"}),b();break;case"fadeInWhite":$("#mask").css({background:"white",display:"inline"}),$("#mask").fadeOut(2e3,b);break;case"fadeIn":$("#mask").css({background:"black",display:"inline"}),$("#mask").fadeOut(2e3,b);break;case"fadeOut":$("#mask").css({background:"black"}),$("#mask").fadeIn(2e3,b)}};